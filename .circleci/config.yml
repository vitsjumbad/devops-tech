version: 2.1

jobs:
  build:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Build Docker image
          command: |
            docker build -t djdevops2025/springboot-devops-demo:latest .

      - run:
          name: Docker login
          command: |
            echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USER" --password-stdin

      - run:
          name: Push image to DockerHub
          command: |
            docker push djdevops2025/springboot-devops-demo:latest

  deploy:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Save EC2 private key
          command: |
            echo "$EC2_PRIVATE_KEY" > ec2-key.pem
            chmod 600 ec2-key.pem

      - run:
           name: SSH and deploy
           command: |
             ssh -o StrictHostKeyChecking=no -i ec2-key.pem $EC2_USER@$EC2_HOST '
             docker login -u "$DOCKERHUB_USER" -p "$DOCKERHUB_PASS" &&
             docker pull djdevops2025/springboot-devops-demo:latest &&
             docker stop app || true &&
             docker rm app || true &&
             docker run -d -p 8081:8081 --name app djdevops2025/springboot-devops-demo:latest
             '



workflows:
  build_and_deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
